# Исправление проблемы с вводом команд при подключении по сети

## Описание проблемы

При подключении к удаленному серверу по сети после выбора сервиса (например, Rand) клиент не мог принимать ввод команд от пользователя, хотя подключение было установлено и показывалось в статистике удаленной консоли.

## Причины проблемы

1. **Отсутствие задержки после подтверждения сервиса**: После получения подтверждения от сервера клиент сразу переходил в неблокирующий режим и начинал ожидать ввод, но сервер мог еще не успеть инициализировать сервис (RandServer/TimeServer/EchoServer).

2. **Проблемы с буферизацией**: Буферы команд и ответов не очищались перед использованием, что могло приводить к проблемам при работе по сети с задержками.

3. **Отсутствие таймаута**: При сетевых задержках клиент мог бесконечно ждать ответа от сервера, блокируя возможность ввода новых команд.

4. **Недостаточная обработка ошибок**: Не было проверки на пустые команды и корректной обработки сетевых задержек.

## Внесенные исправления

### 1. Добавлена задержка после подтверждения сервиса

```cpp
// Небольшая задержка для инициализации сервиса на сервере
Sleep(100);
```

Это дает серверу время на запуск потока сервиса (RandServer/TimeServer/EchoServer) перед началом приема команд.

### 2. Улучшена обработка ввода команд

```cpp
// Очистка буфера перед вводом
memset(command, 0, sizeof(command));
cin >> command;

// Проверка на пустую команду
if (strlen(command) == 0) {
    continue;
}
```

Буфер команды очищается перед каждым вводом, что предотвращает проблемы с остаточными данными.

### 3. Добавлен таймаут ожидания ответа

```cpp
int timeoutCounter = 0;
const int maxTimeout = 300; // 30 секунд максимум ожидания (300 * 100ms)

while (awaitingResponse && timeoutCounter < maxTimeout) {
    // ...
    if (WSAGetLastError() == WSAEWOULDBLOCK) {
        Sleep(100);
        timeoutCounter++;
    }
}

if (timeoutCounter >= maxTimeout) {
    cout << "Превышено время ожидания ответа от сервера" << endl;
    sessionActive = false;
}
```

Это предотвращает бесконечное ожидание ответа при сетевых проблемах.

### 4. Улучшена обработка получения данных

```cpp
// Очистка буфера перед получением
memset(obuf, 0, sizeof(obuf));

int recvResult = recv(SocketTCP, obuf, sizeof(obuf), NULL);
if (recvResult > 0) {
    // Обработка полученных данных
}
```

Буфер ответа очищается перед получением, что гарантирует корректную обработку данных.

### 5. Улучшено сообщение для пользователя

```cpp
cout << "Введите сообщение для сервиса (для Rand/Time введите название сервиса, exit для завершения):" << endl;
```

Пользователю теперь ясно, что нужно вводить название сервиса (Rand, Time) для работы с соответствующими сервисами.

## Как использовать после исправления

1. **Подключитесь к серверу** (по IP или позывному)
2. **Выберите сервис** (1 - Rand, 2 - Time, 3 - Echo)
3. **Дождитесь подтверждения** от сервера
4. **Введите команду**:
   - Для **Rand**: введите `Rand` (с большой буквы!)
   - Для **Time**: введите `Time` (с большой буквы!)
   - Для **Echo**: введите любое сообщение (оно будет возвращено)
   - Для завершения: введите `exit`

## Важные замечания

1. **Регистр имеет значение**: Сервер ожидает точное совпадение - `Rand`, `Time`, `Echo` (с большой буквы). `rand`, `RAND`, `Rand ` (с пробелом) не будут работать.

2. **Сетевые задержки**: При работе по сети могут быть задержки. Если ответ не приходит в течение 30 секунд, соединение будет закрыто.

3. **Одно подключение - один сервис**: После выбора сервиса (Rand/Time/Echo) вы работаете только с этим сервисом до завершения соединения.

## Пример работы

```
1 - Подключение по имени сервера
2 - Подключение по позывному
1
Введите имя сервера: 192.168.1.100
Порт сервера: 2000

1 - Rand
2 - Time
3 - Echo
1

Введите сообщение для сервиса (для Rand/Time введите название сервиса, exit для завершения):
Rand
Полученное сообщение:[Rand: 12345]
Введите сообщение для сервиса (exit для завершения):
Rand
Полученное сообщение:[Rand: 67890]
Введите сообщение для сервиса (exit для завершения):
exit
Сервер завершил соединение: Close: finish;
```

## Проверка работы

1. Убедитесь, что сервер запущен и показывает активное подключение в статистике
2. Проверьте, что вы вводите команду с правильным регистром
3. Если проблема сохраняется, проверьте:
   - Firewall настройки
   - Сетевые задержки (ping сервера)
   - Логи сервера на наличие ошибок




