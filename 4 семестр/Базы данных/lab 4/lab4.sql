/* 1. Создание базы данных 
CREATE DATABASE lab3;
USE lab3;*/

CREATE TABLE ТОВАРЫ (
    id INT PRIMARY KEY AUTO_INCREMENT,
    Наименование NVARCHAR(20) UNIQUE,
    Цена REAL
);

CREATE TABLE ЗАКАЗЧИКИ (
    id INT PRIMARY KEY AUTO_INCREMENT,
    Наименование_фирмы NVARCHAR(50) UNIQUE,
    Адрес NVARCHAR(100),
    Расчетный_счет NVARCHAR(20)
);

CREATE TABLE КОНТАКТЫ_ЗАКАЗЧИКОВ (
    id INT PRIMARY KEY AUTO_INCREMENT,
    заказчик_id INT,
    Контактное_лицо NVARCHAR(50),
    Телефон NVARCHAR(20),
    FOREIGN KEY (заказчик_id) REFERENCES ЗАКАЗЧИКИ(id)
);

CREATE TABLE ПОСТАВКИ (
    id INT PRIMARY KEY AUTO_INCREMENT,
    товар_id INT,
    Дата_поставки DATE,
    Количество INT,
    FOREIGN KEY (товар_id) REFERENCES ТОВАРЫ(id)
);

CREATE TABLE ЗАКАЗЫ (
    id INT PRIMARY KEY AUTO_INCREMENT,
    Номер_заказа NVARCHAR(10) UNIQUE,
    заказчик_id INT,
    Дата_оформления DATE,
    FOREIGN KEY (заказчик_id) REFERENCES ЗАКАЗЧИКИ(id)
);

CREATE TABLE ДЕТАЛИ_ЗАКАЗА (
    id INT PRIMARY KEY AUTO_INCREMENT,
    заказ_id INT,
    товар_id INT,
    Цена_продажи REAL,
    Количество INT,
    FOREIGN KEY (заказ_id) REFERENCES ЗАКАЗЫ(id),
    FOREIGN KEY (товар_id) REFERENCES ТОВАРЫ(id)
);

INSERT INTO ТОВАРЫ (Наименование, Цена) VALUES 
('Ноутбук', 7000),
('Смартфон', 4000),
('Планшет', 3000),
('Монитор', 2500),
('Клавиатура', 500),
('Колонки', 300),
('Компьютерная_мышь', 200);

INSERT INTO ЗАКАЗЧИКИ (Наименование_фирмы, Адрес, Расчетный_счет) VALUES
('21 век', 'Минск, пр.Независимости, 10', 'BY30UNBS30121'),
('Электросила', 'Минск, ул.Притыцкого, 50', 'BY30UNBS30122');

INSERT INTO КОНТАКТЫ_ЗАКАЗЧИКОВ (заказчик_id, Контактное_лицо, Телефон) VALUES
(1, 'Иванов Петр', '+375291234567'),
(2, 'Сидоров Алексей', '+375332345678');

INSERT INTO ЗАКАЗЫ (Номер_заказа, заказчик_id, Дата_оформления) VALUES
('Z001', 1, '2025-03-10'),
('Z002', 2, '2025-03-12');

INSERT INTO ДЕТАЛИ_ЗАКАЗА (заказ_id, товар_id, Цена_продажи, Количество) VALUES
(1, 1, 7400, 2),
(2, 2, 4900, 5);

INSERT INTO ПОСТАВКИ (товар_id, Дата_поставки, Количество) VALUES
(1, '2025-03-15', 2),
(2, '2025-03-20', 5);

SELECT * FROM ЗАКАЗЫ;
SELECT Наименование, Цена FROM ТОВАРЫ;
SELECT COUNT(*) FROM ЗАКАЗЫ;
UPDATE ТОВАРЫ SET Цена = Цена * 1.1 WHERE Наименование = 'Ноутбук';
SELECT * FROM ТОВАРЫ WHERE Наименование = 'Ноутбук';

ALTER TABLE ТОВАРЫ ADD COLUMN Производитель NVARCHAR(50);
ALTER TABLE ТОВАРЫ ADD CONSTRAINT chk_Цена CHECK (Цена > 0);
ALTER TABLE ТОВАРЫ DROP COLUMN Производитель;

/* 5. Изменение структуры таблицы */
ALTER DATABASE lab3 ADD FILEGROUP fg_Товары;

ALTER DATABASE lab3 ADD FILE 
(NAME = 'ТоварыData', FILENAME = '/Users/yanpaulovich/Документы/fit/БД/lab 2/Товары.ndf') TO FILEGROUP fg_Товары;

CREATE TABLE ТОВАРЫ (
    id INT PRIMARY KEY AUTO_INCREMENT,
    Наименование NVARCHAR(20) UNIQUE,
    Цена REAL
) ON fg_Товары;

ALTER DATABASE lab3 ADD FILEGROUP fg_ЗАКАЗЧИКИ;
ALTER DATABASE lab3 ADD FILE 
(NAME = 'ЗАКАЗЧИКИData', FILENAME = '/Users/yanpaulovich/Документы/fit/БД/lab 2/ЗАКАЗЧИКИ.ndf') TO FILEGROUP fg_ЗАКАЗЧИКИ;

CREATE TABLE ЗАКАЗЧИКИ (
    id INT PRIMARY KEY AUTO_INCREMENT,
    Наименование_фирмы NVARCHAR(50) UNIQUE,
    Адрес NVARCHAR(100),
    Расчетный_счет NVARCHAR(20)
) ON fg_ЗАКАЗЧИКИ;

/* 7. SQLCMD для справки 
!sqlcmd -?;*/




INSERT INTO ТОВАРЫ (Наименование, Цена) VALUES 
('Телевизор', 8000),
('Принтер', 3500),
('Сканер', 2800),
('Проектор', 6500),
('Флеш-накопитель', 700),
('Жесткий диск', 4500),
('Наушники', 1200);

INSERT INTO ЗАКАЗЧИКИ (Наименование_фирмы, Адрес, Расчетный_счет) VALUES
('ТехноДом', 'Минск, ул.Ленина, 12', 'BY30UNBS30123'),
('КомпСервис', 'Минск, ул.Купалы, 34', 'BY30UNBS30124'),
('ГаджетПлюс', 'Минск, ул.Победы, 56', 'BY30UNBS30125'),
('Мобильный Рай', 'Минск, ул.Фрунзе, 78', 'BY30UNBS30126'),
('ДигиталМаркет', 'Минск, ул.Гагарина, 90', 'BY30UNBS30127'),
('ЭлектроТренд', 'Минск, ул.Первомайская, 11', 'BY30UNBS30128'),
('РетроТехника', 'Минск, ул.Советская, 22', 'BY30UNBS30129');

INSERT INTO КОНТАКТЫ_ЗАКАЗЧИКОВ (заказчик_id, Контактное_лицо, Телефон) VALUES
(3, 'Козлов Михаил', '+375291111111'),
(4, 'Романов Сергей', '+375292222222'),
(5, 'Лебедев Антон', '+375293333333'),
(6, 'Морозова Анастасия', '+375294444444'),
(7, 'Захарова Ольга', '+375295555555'),
(8, 'Игнатов Виктор', '+375296666666'),
(9, 'Самойлов Артем', '+375297777777');

INSERT INTO ЗАКАЗЫ (Номер_заказа, заказчик_id, Дата_оформления) VALUES
('Z003', 3, '2025-03-14'),
('Z004', 4, '2025-03-15'),
('Z005', 5, '2025-03-16'),
('Z006', 6, '2025-03-17'),
('Z007', 7, '2025-03-18'),
('Z008', 8, '2025-03-19'),
('Z009', 9, '2025-03-20');

INSERT INTO ДЕТАЛИ_ЗАКАЗА (заказ_id, товар_id, Цена_продажи, Количество) VALUES
(3, 3, 3100, 1),
(4, 4, 2700, 2),
(5, 5, 550, 3),
(6, 6, 320, 4),
(7, 7, 220, 5),
(8, 1, 7500, 1),
(9, 2, 4200, 2);

INSERT INTO ПОСТАВКИ (товар_id, Дата_поставки, Количество) VALUES
(3, '2025-03-22', 3),
(4, '2025-03-23', 4),
(5, '2025-03-24', 5),
(6, '2025-03-25', 6),
(7, '2025-03-26', 7),
(1, '2025-03-27', 8),
(2, '2025-03-28', 9);



/*LAB 4*/
SELECT ЗАКАЗЫ.Номер_заказа, ЗАКАЗЧИКИ.Наименование_фирмы, ЗАКАЗЫ.Дата_оформления
FROM ЗАКАЗЫ
INNER JOIN ЗАКАЗЧИКИ ON ЗАКАЗЫ.заказчик_id = ЗАКАЗЧИКИ.id;

SELECT ТОВАРЫ.Наименование, ДЕТАЛИ_ЗАКАЗА.Количество
FROM ДЕТАЛИ_ЗАКАЗА
INNER JOIN ТОВАРЫ ON ДЕТАЛИ_ЗАКАЗА.товар_id = ТОВАРЫ.id;

SELECT ЗАКАЗЫ.Номер_заказа, ТОВАРЫ.Наименование, ДЕТАЛИ_ЗАКАЗА.Количество
FROM ЗАКАЗЫ
INNER JOIN ДЕТАЛИ_ЗАКАЗА ON ЗАКАЗЫ.id = ДЕТАЛИ_ЗАКАЗА.заказ_id
INNER JOIN ТОВАРЫ ON ДЕТАЛИ_ЗАКАЗА.товар_id = ТОВАРЫ.id;



SELECT КОНТАКТЫ_ЗАКАЗЧИКОВ.Контактное_лицо, ЗАКАЗЧИКИ.Наименование_фирмы, КОНТАКТЫ_ЗАКАЗЧИКОВ.Телефон
FROM КОНТАКТЫ_ЗАКАЗЧИКОВ
INNER JOIN ЗАКАЗЧИКИ ON КОНТАКТЫ_ЗАКАЗЧИКОВ.заказчик_id = ЗАКАЗЧИКИ.id;

SELECT ТОВАРЫ.Наименование, ПОСТАВКИ.Дата_поставки, ПОСТАВКИ.Количество
FROM ПОСТАВКИ
INNER JOIN ТОВАРЫ ON ПОСТАВКИ.товар_id = ТОВАРЫ.id;

SELECT ЗАКАЗЧИКИ.Наименование_фирмы, ЗАКАЗЫ.Номер_заказа, ЗАКАЗЫ.Дата_оформления
FROM ЗАКАЗЧИКИ
INNER JOIN ЗАКАЗЫ ON ЗАКАЗЧИКИ.id = ЗАКАЗЫ.заказчик_id;



SELECT Наименование, Цена,
       CASE 
           WHEN Цена > 5000 THEN 'Дорогой'
           WHEN Цена BETWEEN 2000 AND 5000 THEN 'Средний'
           ELSE 'Дешевый'
       END AS Категория
FROM ТОВАРЫ;

SELECT Наименование, Цена,
       CASE 
           WHEN Цена > 5000 THEN Цена * 0.9  -- 10%
           WHEN Цена BETWEEN 2000 AND 5000 THEN Цена * 0.95 -- 5%
           ELSE Цена -- без скидки
       END AS Цена_со_скидкой
FROM ТОВАРЫ;

SELECT ТОВАРЫ.Наименование, ДЕТАЛИ_ЗАКАЗА.Цена_продажи, ТОВАРЫ.Цена,
       CASE 
           WHEN ДЕТАЛИ_ЗАКАЗА.Цена_продажи > ТОВАРЫ.Цена THEN 'Прибыльно'
           ELSE 'Убыточно'
       END AS Оценка
FROM ДЕТАЛИ_ЗАКАЗА
INNER JOIN ТОВАРЫ ON ДЕТАЛИ_ЗАКАЗА.товар_id = ТОВАРЫ.id;



SELECT ЗАКАЗЧИКИ.Наименование_фирмы, 
       IFNULL(ЗАКАЗЫ.Номер_заказа, 'Нет заказов') AS Номер_заказа
FROM ЗАКАЗЧИКИ
LEFT JOIN ЗАКАЗЫ ON ЗАКАЗЧИКИ.id = ЗАКАЗЫ.заказчик_id;

SELECT ТОВАРЫ.Наименование, 
       IFNULL(ПОСТАВКИ.Дата_поставки, 'Нет поставки') AS Дата_поставки
FROM ТОВАРЫ
LEFT JOIN ПОСТАВКИ ON ТОВАРЫ.id = ПОСТАВКИ.товар_id;

SELECT ЗАКАЗЫ.Номер_заказа, 
       IFNULL(ТОВАРЫ.Наименование, 'Нет деталей') AS Наименование_товара
FROM ЗАКАЗЫ
LEFT JOIN ДЕТАЛИ_ЗАКАЗА ON ЗАКАЗЫ.id = ДЕТАЛИ_ЗАКАЗА.заказ_id
LEFT JOIN ТОВАРЫ ON ДЕТАЛИ_ЗАКАЗА.товар_id = ТОВАРЫ.id;

SELECT ЗАКАЗЧИКИ.Наименование_фирмы, 
       IF(ЗАКАЗЫ.Номер_заказа IS NOT NULL, ЗАКАЗЫ.Номер_заказа, 'Нет заказов') AS Номер_заказа
FROM ЗАКАЗЧИКИ
LEFT JOIN ЗАКАЗЫ ON ЗАКАЗЧИКИ.id = ЗАКАЗЫ.заказчик_id;



SELECT ЗАКАЗЧИКИ.Наименование_фирмы, ЗАКАЗЫ.Номер_заказа, ЗАКАЗЫ.Дата_оформления
FROM ЗАКАЗЧИКИ
LEFT JOIN ЗАКАЗЫ ON ЗАКАЗЧИКИ.id = ЗАКАЗЫ.заказчик_id
UNION
SELECT ЗАКАЗЧИКИ.Наименование_фирмы, ЗАКАЗЫ.Номер_заказа, ЗАКАЗЫ.Дата_оформления
FROM ЗАКАЗЧИКИ
RIGHT JOIN ЗАКАЗЫ ON ЗАКАЗЧИКИ.id = ЗАКАЗЫ.заказчик_id;

SELECT ТОВАРЫ.Наименование, ДЕТАЛИ_ЗАКАЗА.Количество
FROM ТОВАРЫ
LEFT JOIN ДЕТАЛИ_ЗАКАЗА ON ТОВАРЫ.id = ДЕТАЛИ_ЗАКАЗА.товар_id
UNION
SELECT ТОВАРЫ.Наименование, ДЕТАЛИ_ЗАКАЗА.Количество
FROM ТОВАРЫ
RIGHT JOIN ДЕТАЛИ_ЗАКАЗА ON ТОВАРЫ.id = ДЕТАЛИ_ЗАКАЗА.товар_id;

SELECT ТОВАРЫ.Наименование, ПОСТАВКИ.Дата_поставки
FROM ТОВАРЫ
LEFT JOIN ПОСТАВКИ ON ТОВАРЫ.id = ПОСТАВКИ.товар_id
UNION
SELECT ТОВАРЫ.Наименование, ПОСТАВКИ.Дата_поставки
FROM ТОВАРЫ
RIGHT JOIN ПОСТАВКИ ON ТОВАРЫ.id = ПОСТАВКИ.товар_id;



SELECT ЗАКАЗЧИКИ.Наименование_фирмы, ЗАКАЗЫ.Номер_заказа
FROM ЗАКАЗЧИКИ
LEFT JOIN ЗАКАЗЫ ON ЗАКАЗЧИКИ.id = ЗАКАЗЫ.заказчик_id
WHERE ЗАКАЗЫ.Номер_заказа IS NULL;

SELECT ЗАКАЗЧИКИ.Наименование_фирмы, ЗАКАЗЫ.Номер_заказа
FROM ЗАКАЗЧИКИ
RIGHT JOIN ЗАКАЗЫ ON ЗАКАЗЧИКИ.id = ЗАКАЗЫ.заказчик_id
WHERE ЗАКАЗЧИКИ.Наименование_фирмы IS NULL;



SELECT ТОВАРЫ.Наименование AS Товар, ЗАКАЗЧИКИ.Наименование_фирмы AS Заказчик
FROM ТОВАРЫ
CROSS JOIN ЗАКАЗЧИКИ;



